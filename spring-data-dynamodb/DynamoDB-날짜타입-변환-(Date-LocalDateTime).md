# DynamoDB 날짜타입 변환 (Date <-> LocalDateTime)

> 참고자료 : [Spring Boot 에서 Repository로 DynamoDB 조작하기 (1) -설정부터 실행까지](https://techblog.woowahan.com/2633/)<br>

<br>

Java DynamoDB SDK 는 JAVA 의 기본 `Date` 타입만 허용한다.<br>

`LocalDateTime` 을 사용하려면 별도로 컨버터를 구현한다<br>

DynamoDB를 쓰면서 코드레벨에서는 LocalDateTime 을 사용하고 싶다면, 아래와 같은 별도의 변환절차들을 구현해서 애노테이션에 적용한다.

- `Date` -> `Instant` -> `LocalDateTime`
- `LocalDateTime` -> `Instant` -> `Date`

<br>

위와 같은 흐름의 로직을 컨버터로 구현하는데 그 절차는 아래와 같다.

- 컨버터를 구현한다. 이 컨버터는 DynamoDB SDK 가 인식할 수 있는 별도의 interface 인 `DynamoDBTypeConverter` 를 `implements` 한 클래스이다.
  - `Date` -> `Instant` -> `LocalDateTime`
  - `LocalDateTime` -> `Instant` -> `Date`
- 구현한 컨버터를  `@DynamoDBTypeConverted` 애노테이션의 `converter` 에 지정해준다.
  - ex `@DynamoDBTypeConverted(converter = LocalDateTimeConverter.class)` private LocalDateTime createdAt;

<br>

## 컨버터 클래스 구현

**LocalDateTimeConverter.java**

```java
package io.inspect.koreanstockinspector.tdd.common;

import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBTypeConverter;

import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.ZoneOffset;
import java.util.Date;

public class LocalDateTimeConverter implements DynamoDBTypeConverter<Date, LocalDateTime> {
    @Override
    public Date convert(LocalDateTime ldt) {
        // LocalDateTime -> Instant -> Date
        return Date.from(ldt.toInstant(ZoneOffset.UTC));
    }

    @Override
    public LocalDateTime unconvert(Date date) {
        // Date -> Instant -> LocalDateTime
        return date.toInstant().atZone(ZoneId.of("Etc/UTC")).toLocalDateTime();
    }
}
```

<br>

## Document 클래스 구현

JPA에서 흔히 이야기하는 `@Entity` 와 같은 개념은 spring-data-mongodb 에서는 `@Document` 이고, DynamoDB에서는 해당 개념을 뭐라고 부르는지 모른다. 그래서 그냥 Document 클래스 구현이라고 해두었다.<br>

<br>

**FinanceGainLossDocumentTest.java**

```java
package io.inspect.koreanstockinspector.tdd.finance.repository.dynamo;

import com.amazonaws.services.dynamodbv2.datamodeling.*;
import io.inspect.koreanstockinspector.tdd.common.LocalDateTimeConverter;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDateTime;

@Getter @Setter
@NoArgsConstructor
@DynamoDBTable(tableName = "FinanceGainLossTest")
public class FinanceGainLossDocuemntTest {
    @DynamoDBHashKey(attributeName = "id")
    @DynamoDBAutoGeneratedKey
    private String id;

    @DynamoDBAttribute
    @DynamoDBIndexHashKey(globalSecondaryIndexName = "sector")
    private String sectorId;

    @DynamoDBAttribute
    @DynamoDBTypeConverted(converter = LocalDateTimeConverter.class)
    private LocalDateTime helloDate;
}

```

위의 코드에서 아래의 부분이 Converter를 사용한 부분이다.<br>

```java
@DynamoDBAttribute
@DynamoDBTypeConverted(converter = LocalDateTimeConverter.class)
private LocalDateTime helloDate;
```

